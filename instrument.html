<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>センサー楽器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  </head>

  <body>
    <h1>センサー楽器</h1>
    <div>
      <div>あなたのID: <span id="myid"></span></div>
      <button id="connect">演奏開始</button>
      <div>
        <p>スマホを左右に傾けると音の高さが、前後に傾けると音量が変わります。</p>
        <p>
          現在の周波数: <span id="freq">0</span> Hz, 現在の音量:
          <span id="vol">0</span> dB
        </p>
      </div>
    </div>
    <script>
      const socket = io.connect('http://localhost:8080'); // サーバーに接続します
      const connectBtn = document.querySelector("#connect");
      const freqEl = document.querySelector("#freq");
      const volEl = document.querySelector("#vol");

      let beta = 0;
      let gamma = 0;

      // --- ユーザーIDの管理 ---
      let myid = sessionStorage.getItem("clientId");
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem("clientId", myid);
      }
      document.querySelector("#myid").innerHTML = myid;
      console.log("あなたのID: ", myid);

      // --- Tone.jsの準備 ---
      // シンセサイザーを作成
      const synth = new Tone.Synth().toDestination();
      // 音量を-Infinity (無音) に設定
      synth.volume.value = -Infinity;

      // --- 接続処理 ---
      connectBtn.addEventListener("click", async () => {
        // ユーザー操作をきっかけにオーディオを開始する
        await Tone.start();
        console.log("Audio is ready");

        // サーバーの 'game' ルームに参加
        socket.emit("join", "game");

        // シンセの音を再生開始 (音量はまだ無音)
        synth.triggerAttack("C4");

        // ボタンを削除
        connectBtn.remove();
      });

      // --- センサーデータ受信処理 ---
      socket.on("sensor", function (data) {
        // data.g は gamma (左右), data.b は beta (前後)
        gamma = parseFloat(data.g);
        beta = parseFloat(data.b);

        // --- センサーの値から音のパラメータを計算 ---

        // 1. 音の高さ (周波数) を計算
        // gamma (-180 ~ 180) を周波数の範囲 (例: 100Hz ~ 1000Hz) にマッピング
        // map() は p5.js の便利な関数
        const freq = map(gamma, -90, 90, 200, 800, true); // trueで範囲内に数値を制限
        synth.frequency.value = freq;

        // 2. 音量 (ボリューム) を計算
        // beta (-90 ~ 90) をデシベルの範囲 (例: -30dB ~ 0dB) にマッピング
        const vol = map(beta, -45, 45, -30, 0, true);
        synth.volume.value = vol;

        // 画面に現在の値を表示
        freqEl.textContent = freq.toFixed(2);
        volEl.textContent = vol.toFixed(2);
      });

      // --- p5.jsの描画処理 (今回は視覚的な表現はシンプルに) ---
      function setup() {
        createCanvas(400, 200);
      }

      function draw() {
        background(220);
        const bgColor = map(gamma, -90, 90, 0, 255);
        background(bgColor, 200, 200);
        text("スマホを傾けて音を操作してください", 20, 20);
      }
    </script>
  </body>
</html>